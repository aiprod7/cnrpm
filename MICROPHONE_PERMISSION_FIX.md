# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –≤ Telegram Mini App

## –ü—Ä–æ–±–ª–µ–º–∞
–í Telegram Mini App –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –±—Ä–∞—É–∑–µ—Ä/WebView –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `getUserMedia()`, —Ö–æ—Ç—è –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ—Å—Ç–∞–≤–∞–ª–æ—Å—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º –≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Å—Å–∏–∏.

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### 1. ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –∞—É–¥–∏–æ (–≥–ª–∞–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ)
**–§–∞–π–ª**: `services/microphoneManager.ts`

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ `MicrophoneManager`:
- `audioStream: MediaStream | null` - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ç–æ–∫ –∞—É–¥–∏–æ
- `audioContext: AudioContext | null` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç
- `mediaSource: MediaStreamAudioSourceNode | null` - –∏—Å—Ç–æ—á–Ω–∏–∫ –º–µ–¥–∏–∞
- `isStreamActive: boolean` - —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ—Ç–æ–∫–∞

**–ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã**:
```typescript
async getAudioStream(constraints?: MediaStreamConstraints['audio']): Promise<MediaStream | null>
```
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ç–æ–∫, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –ø–æ–ª—É—á–µ–Ω
- –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ—Ç–æ–∫ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```typescript
async getAudioStreamWithRetry(maxRetries: number = 3): Promise<MediaStream | null>
```
- –ü–æ–ª—É—á–∞–µ—Ç –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ (–¥–æ 3 —Ä–∞–∑)
- –î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ (500ms, 1000ms, 1500ms)

```typescript
async initializeAudioRecording(): Promise<{audioContext, mediaSource, stream} | null>
```
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç Web Audio API —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç AudioContext –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏

### 2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —á–µ—Ä–µ–∑ Permissions API
**–§–∞–π–ª**: `services/microphoneManager.ts`

```typescript
async checkMicrophonePermission(): Promise<string | null>
```
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º: `'granted'`, `'denied'`, `'prompt'`
- –ò–∑–±–µ–≥–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, –µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —É–∂–µ –¥–∞–Ω–æ

–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:
1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ Permissions API
2. –ï—Å–ª–∏ `'granted'` - —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—Ö
3. –ï—Å–ª–∏ `'denied'` - –Ω–µ –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å
4. –ï—Å–ª–∏ `'prompt'` - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ

### 3. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã retry-–º–µ—Ö–∞–Ω–∏–∑–º—ã:
- 3 –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫–∞
- –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –Ω–∞ –±–∞–∑–æ–≤—ã–µ constraints –ø—Ä–∏ –æ—à–∏–±–∫–µ

### 4. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram Web App SDK
**–§–∞–π–ª**: `services/microphoneManager.ts`

```typescript
private initializeTelegramWebApp(): void
```
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è `window.Telegram.WebApp.ready()`
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è `viewportChanged` - –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è `popupClosed` - –ø–æ—Ç–æ–∫ –æ—Å—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º
- –û–±—Ä–∞–±–æ—Ç–∫–∞ `beforeunload` - –ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ

### 5. ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø–æ—Ç–æ–∫–∞
**–ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã**:

```typescript
pauseRecording(): void
```
- –ü—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –ë–ï–ó –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ—Ç–æ–∫–∞
- –ü–æ—Ç–æ–∫ –æ—Å—Ç–∞–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–º –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```typescript
cleanupAudio(): void
```
- –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –∞—É–¥–∏–æ —Ä–µ—Å—É—Ä—Å–æ–≤
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```typescript
clearPermission(): void
```
- –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
- –¢–∞–∫–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç `cleanupAudio()`

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö

### VoiceService
**–§–∞–π–ª**: `services/voiceService.ts`

**–î–æ**:
```typescript
this.stream = await navigator.mediaDevices.getUserMedia({ audio: {...} });
```

**–ü–æ—Å–ª–µ**:
```typescript
this.stream = await microphoneManager.getAudioStream({...});
```

### LiveTranscriptionService
**–§–∞–π–ª**: `services/liveTranscriptionService.ts`

**–î–æ**:
```typescript
this.mediaStream = await navigator.mediaDevices.getUserMedia({ audio: {...} });
```

**–ü–æ—Å–ª–µ**:
```typescript
this.mediaStream = await microphoneManager.getAudioStream({...});
if (!this.mediaStream) {
  throw new Error('Failed to get audio stream');
}
```

### GeminiLiveService
**–§–∞–π–ª**: `services/geminiLiveService.ts`

**–î–æ**:
```typescript
this.mediaStream = await navigator.mediaDevices.getUserMedia({...});
```

**–ü–æ—Å–ª–µ**:
```typescript
this.mediaStream = await microphoneManager.getAudioStream({...});
if (!this.mediaStream) {
  throw new Error('Failed to get audio stream');
}
```

### GeminiService
**–§–∞–π–ª**: `services/geminiService.ts`

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `microphoneManager.getAudioStream()`.

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –≤ —Å–µ—Å—Å–∏–∏:
1. `microphoneManager.initialize()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Permissions API
2. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `getUserMedia()`
3. **–í–ê–ñ–ù–û**: –ü–æ—Ç–æ–∫ –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `audioStream`
4. –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –≤ Telegram Storage –∏ localStorage

### –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –≤ —Ç–æ–π –∂–µ —Å–µ—Å—Å–∏–∏:
1. –°–µ—Ä–≤–∏—Å –≤—ã–∑—ã–≤–∞–µ—Ç `microphoneManager.getAudioStream()`
2. MicrophoneManager –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ç–æ–∫**
3. **–ù–ï–¢ –ù–û–í–û–ì–û –ó–ê–ü–†–û–°–ê** —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è - –Ω–µ—Ç –¥–∏–∞–ª–æ–≥–∞!

### –ü—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
1. –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ `beforeunload`
2. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `microphoneManager.cleanupAudio()`
3. –í—Å–µ —Ç—Ä–µ–∫–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è, –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
4. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–æ–≤–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (–Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏)

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

‚úÖ **–û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è** - –≤ –Ω–∞—á–∞–ª–µ —Å–µ—Å—Å–∏–∏, –∞ –Ω–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏  
‚úÖ **–ë—ã—Å—Ç—Ä–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ** - –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏ –∑–∞–ø–∏—Å–∏ –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫  
‚úÖ **–≠–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤** - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ AudioContext  
‚úÖ **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å** - retry-–º–µ—Ö–∞–Ω–∏–∑–º—ã –ø—Ä–∏ —Å–±–æ—è—Ö  
‚úÖ **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ iOS, Android, Desktop  

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã:
1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
2. –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –¥–∞–π—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω
3. –ó–∞–ø–∏—à–∏—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
4. **–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º** –∏ –æ–±—Ä–∞—Ç–Ω–æ
5. –ó–∞–ø–∏—à–∏—Ç–µ –µ—â–µ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
6. ‚úÖ **–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ù–ï –¥–æ–ª–∂–Ω–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ**

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–∏—Å—Ç–∫–∏:
1. –ó–∞–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–π–¥–∏—Ç–µ –∏–∑ Mini App)
2. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–Ω–æ–≤–∞
3. ‚úÖ –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–æ—Ä–º–∞–ª–µ–Ω –¥–ª—è –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏

## Debug –ª–æ–≥–∏

–î–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Å–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–Ω—Å–æ–ª—å –Ω–∞ –Ω–∞–ª–∏—á–∏–µ:
- `‚úÖ [MicManager] Returning cached audio stream (no new permission request)` - –ø–æ—Ç–æ–∫ –∏–∑ –∫—ç—à–∞
- `üîÑ [MicManager] Creating new audio stream...` - –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
- `üßπ [MicManager] Cleaning up audio resources` - –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [Permissions API MDN](https://developer.mozilla.org/en-US/docs/Web/API/Permissions_API)
- [getUserMedia() MDN](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)
- [Web Audio API MDN](https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API)
- [Telegram Web App SDK](https://core.telegram.org/bots/webapps)
